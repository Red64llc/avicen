<%# Partial for individual medication fields in the prescription review form
    Task 10.2 - Requirements: 5.1, 5.4, 5.7

    Local variables:
    - form: the form builder object
    - med: hash containing medication data (drug_name, dosage, frequency, etc.)
    - index: the medication index for form field naming
    - is_template: boolean, true when used in the template for adding new medications
%>
<% is_template ||= false %>
<% low_confidence = med[:confidence].present? && med[:confidence] < 0.8 %>
<% requires_verification = med[:requires_verification] || low_confidence %>

<div class="medication-entry border rounded-lg p-4 relative <%= requires_verification ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200' %>"
     data-review-form-target="medicationEntry"
     data-medication-index="<%= index %>">

  <%# Remove button %>
  <button type="button"
          class="absolute top-2 right-2 text-gray-400 hover:text-red-500 focus:outline-none"
          data-action="click->review-form#removeMedication"
          title="Remove Medication">
    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
    <span class="sr-only">Remove</span>
  </button>

  <%# Verification warning %>
  <% if requires_verification %>
    <div class="mb-3 text-sm text-yellow-700 flex items-center">
      <svg class="h-4 w-4 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
      </svg>
      Please verify this medication
    </div>
  <% end %>

  <%# Matched drug metadata %>
  <% if med[:matched_drug_id].present? %>
    <div class="mb-3 text-sm text-green-700 flex items-center bg-green-50 rounded px-2 py-1">
      <svg class="h-4 w-4 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
      </svg>
      <span>
        Matched in database
        <% if med[:active_ingredients].present? %>
          <span class="text-green-600 ml-1">(Active ingredients: <%= Array(med[:active_ingredients]).join(", ") %>)</span>
        <% end %>
      </span>
    </div>
  <% end %>

  <%# Row 1: Drug name (with autocomplete) and Dosage %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <%# Drug name with autocomplete %>
    <div>
      <%= form.label "medications[#{index}][drug_name]", "Medication Name", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <div data-controller="drug-search"
           data-drug-search-url-value="/drugs/search"
           data-drug-search-min-length-value="2"
           class="relative"
           role="combobox">
        <%= form.text_field "medications[#{index}][drug_name]",
            value: med[:drug_name],
            class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary pr-8",
            data: {
              drug_search_target: "input",
              review_form_target: "field",
              field_name: "medications_#{index}_drug_name",
              confidence: med[:confidence],
              action: "input->review-form#markVerified blur->review-form#markVerified"
            },
            placeholder: "Search for a medication...",
            autocomplete: "off" %>
        <%= form.hidden_field "medications[#{index}][drug_id]",
            value: med[:matched_drug_id],
            data: { drug_search_target: "hidden" } %>
        <ul data-drug-search-target="results"
            class="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm hidden">
        </ul>
      </div>
      <%# Hidden field for verification tracking %>
      <%= form.hidden_field "medications[#{index}][verified_drug_name]",
          value: "",
          data: { review_form_target: "verifiedInput", field_name: "medications_#{index}_drug_name" } %>
    </div>

    <%# Dosage %>
    <div>
      <%= form.label "medications[#{index}][dosage]", "Dosage", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.text_field "medications[#{index}][dosage]",
          value: med[:dosage],
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary",
          data: {
            review_form_target: "field",
            field_name: "medications_#{index}_dosage",
            confidence: med[:confidence],
            action: "input->review-form#markVerified blur->review-form#markVerified"
          },
          placeholder: "e.g., 500mg" %>
      <%= form.hidden_field "medications[#{index}][verified_dosage]",
          value: "",
          data: { review_form_target: "verifiedInput", field_name: "medications_#{index}_dosage" } %>
    </div>
  </div>

  <%# Row 2: Frequency and Duration %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <%# Frequency %>
    <div>
      <%= form.label "medications[#{index}][frequency]", "Frequency", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.text_field "medications[#{index}][frequency]",
          value: med[:frequency],
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary",
          data: {
            review_form_target: "field",
            field_name: "medications_#{index}_frequency",
            confidence: med[:confidence],
            action: "input->review-form#markVerified blur->review-form#markVerified"
          },
          placeholder: "e.g., twice daily" %>
      <%= form.hidden_field "medications[#{index}][verified_frequency]",
          value: "",
          data: { review_form_target: "verifiedInput", field_name: "medications_#{index}_frequency" } %>
    </div>

    <%# Duration %>
    <div>
      <%= form.label "medications[#{index}][duration]", "Duration", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.text_field "medications[#{index}][duration]",
          value: med[:duration],
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary",
          data: {
            review_form_target: "field",
            field_name: "medications_#{index}_duration",
            confidence: med[:confidence],
            action: "input->review-form#markVerified blur->review-form#markVerified"
          },
          placeholder: "e.g., 30 days" %>
      <%= form.hidden_field "medications[#{index}][verified_duration]",
          value: "",
          data: { review_form_target: "verifiedInput", field_name: "medications_#{index}_duration" } %>
    </div>
  </div>

  <%# Row 3: Quantity (optional) %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <%# Quantity %>
    <div>
      <%= form.label "medications[#{index}][quantity]", "Quantity", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.text_field "medications[#{index}][quantity]",
          value: med[:quantity],
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary",
          data: {
            review_form_target: "field",
            field_name: "medications_#{index}_quantity",
            confidence: med[:confidence],
            action: "input->review-form#markVerified blur->review-form#markVerified"
          },
          placeholder: "e.g., 30 tablets" %>
      <%= form.hidden_field "medications[#{index}][verified_quantity]",
          value: "",
          data: { review_form_target: "verifiedInput", field_name: "medications_#{index}_quantity" } %>
    </div>

    <%# Confidence indicator for low confidence medications %>
    <% if low_confidence %>
      <div class="flex items-end pb-2">
        <div class="text-xs text-gray-500 flex items-center" data-review-form-target="confidence" data-confidence="<%= med[:confidence] %>">
          <svg class="h-4 w-4 mr-1 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          Confidence: <%= (med[:confidence] * 100).round %>%
        </div>
      </div>
    <% end %>
  </div>
</div>
