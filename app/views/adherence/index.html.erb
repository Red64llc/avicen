<div class="max-w-5xl mx-auto">
  <h1 class="text-2xl font-bold text-gray-900 mb-2">Adherence History</h1>

  <%# Period selection controls %>
  <div class="flex items-center gap-2 mb-6">
    <span class="text-sm font-medium text-gray-700">Period:</span>
    <% [7, 30, 90].each do |period| %>
      <%= link_to "#{period} days",
          adherence_path(period: period),
          class: "inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md #{@period == period ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
    <% end %>
  </div>

  <%# Overall adherence percentage %>
  <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-500">Overall Adherence</p>
        <p class="text-3xl font-bold text-gray-900"><%= number_to_percentage(@summary.overall_percentage, precision: 1) %></p>
      </div>
      <div class="text-sm text-gray-500">
        Last <%= @period %> days
      </div>
    </div>
  </div>

  <%# Calendar heatmap %>
  <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Daily Adherence</h2>
    <div data-heatmap class="grid gap-1" style="grid-template-columns: repeat(7, 1fr);">
      <%# Day of week headers %>
      <% %w[Mon Tue Wed Thu Fri Sat Sun].each do |day_name| %>
        <div class="text-center text-xs font-medium text-gray-500 pb-1"><%= day_name %></div>
      <% end %>

      <% # Compute the grid: start from the first day, pad to align with day-of-week columns
         sorted_dates = @summary.daily_adherence.keys.sort
         if sorted_dates.any?
           first_date = sorted_dates.first
           # Monday=0 offset for grid alignment (Ruby wday: 0=Sun, 1=Mon, etc.)
           # Convert to Mon=0 offset
           first_day_offset = (first_date.wday + 6) % 7
         else
           first_day_offset = 0
         end
      %>

      <%# Empty cells for alignment %>
      <% first_day_offset.times do %>
        <div></div>
      <% end %>

      <%# Heatmap day cells %>
      <% sorted_dates.each do |date| %>
        <% intensity = @summary.daily_adherence[date] || 0.0 %>
        <%= link_to adherence_path(period: @period, date: date.to_s),
            class: "block w-full aspect-square rounded-sm border border-gray-200 hover:border-blue-400 transition-colors #{'ring-2 ring-blue-500' if @selected_date == date}",
            style: "--intensity: #{intensity}; background-color: color-mix(in srgb, #22c55e calc(var(--intensity) * 100%), #f3f4f6);",
            aria: { label: "#{date.strftime('%B %-d, %Y')}: #{(intensity * 100).round}% adherence" } do %>
          <span class="sr-only"><%= date.strftime("%b %-d") %></span>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# Date detail view (when a date is selected) %>
  <% if @selected_date %>
    <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">
        Detail for <%= @selected_date.strftime("%A, %B %-d, %Y") %>
      </h2>
      <% if @date_logs.present? %>
        <div class="divide-y divide-gray-100">
          <% @date_logs.each do |log| %>
            <div class="py-3 flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-900"><%= log.medication.drug.name %></p>
                <p class="text-xs text-gray-500">
                  <%= log.medication_schedule.time_of_day %> &middot; <%= log.medication.dosage %>
                </p>
                <% if log.reason.present? %>
                  <p class="text-xs text-gray-400 italic mt-0.5">Reason: <%= log.reason %></p>
                <% end %>
              </div>
              <div>
                <% if log.taken? %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Taken</span>
                <% elsif log.skipped? %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Skipped</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-gray-500">No log entries for this day.</p>
      <% end %>
    </div>
  <% end %>

  <%# Per-medication statistics table %>
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <h2 class="text-lg font-semibold text-gray-900 px-4 py-3 border-b border-gray-200">Medication Statistics</h2>
    <% if @summary.medication_stats.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medication</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Scheduled</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Taken</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Skipped</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Missed</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Adherence</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @summary.medication_stats.each do |stat| %>
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900">
                  <div class="font-medium"><%= stat.medication.drug.name %></div>
                  <div class="text-xs text-gray-500"><%= stat.medication.dosage %> &middot; <%= stat.medication.form %></div>
                </td>
                <td class="px-4 py-3 text-sm text-right text-gray-700"><%= stat.total_scheduled %></td>
                <td class="px-4 py-3 text-sm text-right text-green-700"><%= stat.total_taken %></td>
                <td class="px-4 py-3 text-sm text-right text-yellow-700"><%= stat.total_skipped %></td>
                <td class="px-4 py-3 text-sm text-right text-red-700"><%= stat.total_missed %></td>
                <td class="px-4 py-3 text-sm text-right font-medium">
                  <span class="<%= stat.percentage >= 80 ? 'text-green-700' : stat.percentage >= 50 ? 'text-yellow-700' : 'text-red-700' %>">
                    <%= number_to_percentage(stat.percentage, precision: 1) %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="px-4 py-8 text-center">
        <p class="text-sm text-gray-500">No active medications with schedules found.</p>
        <p class="mt-1 text-xs text-gray-400">Add medications and configure schedules from your <%= link_to "prescriptions", prescriptions_path, class: "text-blue-600 hover:text-blue-700 underline" %>.</p>
      </div>
    <% end %>
  </div>
</div>
